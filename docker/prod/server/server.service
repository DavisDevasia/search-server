#!/bin/bash

WATCH_FILE=/home/search/data/new/RELOAD
CURRENT_TS=0
RSYNC_SERVER=`cat /code/consul_indexer.json`

while [ 1 ]
do
    echo "connect rsync to $RSYNC_SERVER"
    rsync rsync://search@$RSYNC_SERVER/data/$INDEXES_VERSION/ --list-only > /tmp/data-list
    if [ $? != "0" ]
    then
	echo "== Failed to get list of data sets. sleeping"
	sleep 30 
	continue
    fi
    TS=`cat /tmp/data-list | colrm 1 46 | grep -i . | sort -r | head -1`
    rm /tmp/data-list

    if [ "$CURRENT_TS" == "$TS" ]
    then
        sleep 30
        continue
    fi

    # Sync over the indexes
    mkdir -p $SEARCH_HOME/data/$TS
    rsync -rv rsync://search@$RSYNC_SERVER/data/$INDEXES_VERSION/$TS $SEARCH_HOME/data
    if [ $? != "0" ]
    then
	echo "== Failure during sync of dataset. Starting over again."
	sleep 5
	continue
    fi

    # remove the old data set and move the current one into place
    rm -rf $SEARCH_HOME/data/current
    mv $SEARCH_HOME/data/$TS $SEARCH_HOME/data/current
    ln -fs $SEARCH_HOME/data/current $SEARCH_HOME/indexdata

    CURRENT_TS=$TS

    # this has got to be my favorite command EVAR
    echo "Kill the search server... \Ã¸/"
    killall -9 java
  
    # Start the search server again
    cd $JETTY_HOME
    /docker-entrypoint.sh java -jar /usr/local/jetty/start.jar &

    # take a well deserved break!
    sleep 3

done   

#    rm -f "$WATCH_FILE"
#    while [ ! -e "$WATCH_FILE" ]; do
#        sleep 1
#    done
#    rm -f "$WATCH_FILE"
#    
